# AWS re:Inforce 2025 - Threat modeling a batch job framework (COM325)

**Video Link:** [Watch on YouTube](https://www.youtube.com/watch?v=HDDncCEuUus)

## Video Information
- **Author:** AWS Events
- **Duration:** 20.6 minutes
- **Word Count:** 4,377 words
- **Publish Date:** 20250619

## Summary
This AWS re:Inforce 2025 session focuses on threat modeling for batch job frameworks, presented by a security expert with extensive experience in penetration testing and financial systems. The presentation draws from a blog series started three years ago, exploring how to securely deploy and run batch jobs, with particular emphasis on financial sector applications like end-of-day processing and dividend calculations.

The speaker emphasizes that security is not about checklists but rather about architectural principles, using threat modeling to build robust security architectures. They discuss how modern AI agents can be viewed as batch jobs, highlighting the importance of understanding predictive models and their implications for security. The presentation covers various real-world security incidents, including breaches at Sumo Logic, CircleCI, and SolarWinds, using these cases to illustrate security principles and defense strategies.

Key recommendations include implementing MFA for batch jobs, separating people from data through automation, securing build processes in private networks, and using hardware security keys for authentication. The speaker emphasizes the importance of understanding network security fundamentals and suggests that many security issues stem from improper implementation rather than inherently flawed security tools or concepts.

## Key Points
- Security should be approached as an architecture based on principles rather than compliance checklists
- Batch jobs require independent verification for correctness based on inputs and outputs
- AI agents can be considered as batch jobs with additional complexity due to predictive models
- MFA implementation is crucial for batch job security
- Separation of people from data through automation enhances security
- Hardware security keys (like YubiKey) provide strong protection against phishing attacks
- Network security and proper network isolation are fundamental to protecting batch processes
- Build processes should be isolated in private networks to prevent supply chain attacks
- Security solutions should focus on proper implementation rather than replacement
- Learning from historical security incidents is vital for improving security architecture

## Technical Details
- End-of-day processing systems for financial institutions
- Dividend processing and interest calculation batch jobs
- Trufflehog tool for scanning environments for exposed secrets
- Evil Jinx tool capabilities for credential theft through proxy attacks
- OAuth code flow vulnerabilities
- Hardware security keys (YubiKey) for web authentication
- Authenticator apps for CLI access
- Private network configurations for batch job isolation
- MFA implementation methods for batch job execution
- Build process security controls and checksums
- Network traffic analysis and packet inspection techniques
- AWS CLI security configurations

## Full Transcript

Hey everyone, thanks for joining me appreciate that you showed up here today. Um, I'm gonna be talking about threat mauling a batch job framework, and this is based on a blog series that I started writing about 3 years ago and then it sort of more from building batch jobs to help with security and how can we use or how do we need to deploy the batch jobs, how can we make that secure, how can you run the batch jobs securely, so all those type of things, right? And so I'm just gonna talk to you today about a little bit about what I thought about as I was writing this and in each of my posts I try to go through and talk about the threats and how I'm addressing them and the configurations and I can't cover it all so the main thing for this talk is gonna be how I'm thinking about security and that comes down to threat modeling. So the first thing is we have a lot of checklists and security everywhere we go, but security is not really checklists compliance is a checklist, right? And so how many companies you know that are fully compliant with all their requirements and yet they're getting data right so there's my proof, right? Um, security is really an architecture and architectures are not based on checklists, they're based on principles, right? And you have to put all those priprinciples together correctly to build a good architecture that is secure. And one of the objectives for how you build that uh architecture is gonna be based on a threat model so you have these attacks that you're trying to defend against and you're going to architect accordingly. So how do we learn how to build good architectures? Well, you read and listen and learn from a lot of great architects such as uh Grace Hopper, who was famously the person who found the first bug in a computer system, it's the Navy system, and it was a literal bug. It was a moth. She talks about that in this presentation which was recently released by the NSA. And it's super interesting how relevant a lot of that still is today, and there are obviously a lot of other great architects like Warner Vogels. If you go to AWS Reinvent my favorite presentation for our keynote is his keynote where he always has something technical in it, and last year's was particularly relevant to what I'm talking about. Because he went through what is a good architecture and how can you build on and what do you need to think about and even says like I can't tell you exactly how to do it here's what you should be thinking about so I would say go back and listen to every um keynote from Warner Vocals. It's a great way to learn. So when we want to threaten all something, first of all, we have to understand what we're building, right? And so, a batch job is essentially a process and it has some inputs, processes some data, and gives you some outputs. You can string batch jobs together so you can have a job that produces an output and that output goes into another job that produces some output and then so on and so forth. Now I don't have time to go over all of these I did another talk on this topic in Mountain View, California earlier this year and I'll include a link to that in these slides, but I'm gonna talk to you about the first one which is end of day. So I used to work for investment bank and banks will have this process called end of day which runs at end of day and it has to go through and it has to evaluate all the accounts and make sure everything's adding up correctly and before they roll to the next day and the new transactions come about. So some examples of batch jobs I worked on were like dividend processing every customer that has a security that paid a dividend needs to get their dividends, not too many, not too little, it has to be right. And another one was in um. Interest on sweep accounts. So sweep account is essentially a bank account that's associated with your, you know, your security account and um the interest has to be paid that night has to be right, it's calculated add to the account, then they roll to the next day, couple of examples. Uh, one of the important things for batch job, there's a list here, don't have time to go over, but you can read it later, but each job can be independently verified for correctness based on its inputs and outputs. So if you think about financial transactions, you're putting something in, you're getting something out, it has to be right. So you wanna make sure that's right. There's some other things here like the, the logic of the order of the steps has to be enforced and things like that. Um, so now I sort of reworked these slides a little bit to talk about AI because I've sort of shifted on my blog to writing a lot about AI and using AI and I just basically realized although I've been writing this about 3 years and before AI agents were all the rage and AI agent is essentially a batch job. So you have some inputs and it's going to maybe use AI to figure out when to run the job or maybe it's gonna use AI in the job or it's gonna use AI after the job runs to call another agent so there's lots of places where we can incorporate AI and when you think about the AI I just want to remember one thing it's a predictive model so you're not gonna always get those same inputs and outputs like I mentioned before. So when you're running some sort of batch job process or some agents that are calling other agents, you may have some sort of predictive model that's giving you something that's not consistent and you probably don't wanna use this for your end of day bank batch processing, right? So those are the things you wanna be careful there, um, and that's essentially so so now let's go into um some of the threat modeling now we know where we're gonna build. Well we're threat modeling we have to understand how the attacks work and a lot of you here are probably already security people that know this, but I do pen testing and essentially I go and enter bad things anywhere I can so that's gonna be forms, that's gonna be headers, cookies, URLs. I'm gonna try to hit any open network ports. I'm basically trying to put that in there that make the system do things it's not supposed to and give me information and when it comes to AI that may be putting in a prompt that will let me get into something I wasn't supposed to get to um through that model. There's been some other talks that are really interesting on that here this week. So when we're thinking about risk and how we reduce our risk when we're doing our threat modeling, um, the risk, I like to think about it as how many chances are you giving attackers so you can think about all those different ways someone can insert data into your systems and all those things are potential risk obviously if you can reduce some of those you can reduce your risk and you wanna make sure you you secure all those different um avenues of attack. And then there are attack vectors which are all the potential points of attack and the ways you can attack them. So for example, if I'm testing a website, I might try to do a cross-site scripting, insert some codes, see if I can get it to respond to me, that's an attack vector. Then we have attack passs which are the path to get to the vulnerability and then what what you can get to afterwards. So once an attack gets onto a system it might try to, you know, the attacker is gonna try to get from there into another system. And I have a tool that I wrote when I use on Pentest where I basically map out all the paths in a customer's AWS account on on the network and say, OK, here are all the thousands of paths if you could close some of those default outbound ports, you can limit what an attacker can get to and exponentially reduce your risk. How do we know what all the attacks are? Well, there's this thing called, uh, minor attack, for example, where they try to have this taxonomy of all the different attacks, and AWBS actually just came up with in another talk I was listening to AWBS CERT came up with something like this for AWS, and I can't remember the name of it, but I will have it in these slides but it's similar to this specifically to AWS where it maps out the different kind of attacks they're seeing at AWSERT. But that can be overwhelming, right? One of the things I like to do is look at what attacks are out there and what are happening, and learn from history. And so I like when I'm doing pen testing, I wanna know what's happening so I know what to test in my customer environment and um any time we're looking at attack in the news really important to appreciate that those people are sharing that information and we don't wanna be, you know, berating them they made a mistake but really saying thank you because you can take what happened to them and look at your own environment and say, oh, could that happen to us. So here's an example from Sumo Logic. So I am friends with uh the person who used to be the CIO there, and they had an incident where someone put their keys in GitHub, and they were using a tool called Trufflehog, and Truffle hog will go out and scan your environment, and it will look for, you know, any sort of secrets. So the attacker got the keys, had access to Truffle hog, and they went out and they tried to use those to get customer data. So the, the pres the article here is very interesting because he also talks about incident response which is not what I do so if you're into that, um, good story, but that story is essentially what happens so how do we defend against that? So one of the things that I really wanted to do when I set out for running this writing this batch job framework because I want to say I wanna enforce MFA every time you run a batch job and that was a really key thing that I want to do because when I'm running pentest and customer accounts I always use a role and I say put requirement for MFA on that role and whatever I'm doing in their account, I always use MFA whether it's on the CLI or what have you. And I explored a lot of different ways to use MFA to kick off a batch job, and I'm gonna have all these links for you here in this slide deck when I release it, and my blog has a lot of some post of paywall on it and there will be a friend link so you can get to them without that paywall so you can check that out if you want. So now let's look at Circle CI. Um, Circle CI was another one where the developer was listening to some cool music and there was a vulnerability in their music software. Tacker got in they were able to get in memory the session even though the developer was using MFA. The session tokens in memory were accessible and also, um, some encryption keys were in memory. So this is a little bit trickier, right? So we're using MFA and MFA is is really, really helpful, but what do we do? This is where batch jobs can help you where you can put your critical actions like that where there's sensitive data involved in a batch job. Don't be running those on the developer machine. Put them in a batch job in a private environment, lock that down and separate the people from the data, which is something that I've heard Warner Vogel say a lot and AWS does a lot, have that automation occur in some, some other lockdown area. Another thing you can do. I Um, learn about network security. I have tons of blog posts on network security showing you how it works down to like um dissecting packets and looking at your network traffic, how to configure a firewall if you're working at home, especially, uh, learn something about network security and how that can help you spot attacks and block attacks. So then we have Solar Winds huge, right? And so Solar Winds is really interesting because the attackers deployed a rogue update and one of the things about that is I went to a network security appliance vendor and I said how are you gonna prevent an attack like that? and he said well if some malware came down to our box it would fail because we do a checksum and therefore it wouldn't be able to run. So if you look at solar ones, more information came out after the fact. What happened was the attackers got into the build process. So after all this stuff was scanned, it's secure, and they kicked off the build process, then they inserted the malware and then the build finished and at what point do you do the checksum? You do it when the build's finished, so build has malware in it and so that whole checksum process is out the window. So how do we defend against that? My question here is, and I don't know all the details, how could they insert something into the build process if the whole network was locked down, like if it was in a batch job running in a private network, no one had direct access, how could they get that malware in there, there are ways, but it would be really hard so I would suggest, you know, really locking down networks to authorized IPs and by the way, in my other slides that I did, I have a lot of other things you can do. I just don't have time to cover it all right now so you can check that out. Um, another one was octopus, so OCTA really got sort of blamed for this, but really what happened is OCTA customers were getting fished. So there's a tool called Evil Jinx, and it will essentially show you the real website that you're logging into except for the URL might be a little different. It's basically proxying that website to you so you go to that website and you log in and it all looks legitimate and actually you are getting to in the end to the right website, but along the way you're going through an attacker server and they're stealing your credentials, your session, what have you, and then you are logged in and working and you never know what happened. And so, um, one of the really dangerous things here is the OF code flow is, is really susceptible to attacking where I see that, um, and actually Microsoft just said we're gonna stop using the device code blow, I should say, um, we're gonna stop using that altogether and so, uh, be really aware of that. How do you defend against that? Well, the the person who built that evil jinx software said they cannot defend they cannot steal the tokens if you're using a hardware security key like a UB key. So that's my recommendation if you're on the web. And my other recommendation is to use the an authenticator app with the CLI. Now I know there are ways of using a UB key with the AWSCLI, but I recommend not doing that for reasons on my blog. So this is what I personally use at the moment. Everything's changing all the time, but um that's my current approach. So as you're thinking through all these attacks, there's a couple of things I see that I call faulty security logic that you wanna think about um when something is not working, often people will say oh let's replace it, you know, let's get rid of passwords or let's get rid of AWS keys or something like that. Sometimes you have to think about. Do we need to replace it or do we need to fix how we're using it? So for example, if you're using long term credentials, MFA, uh, AWBS keys, you can add MFA, you can add IP conditions and things like that. So if you really need them, there are ways to make them more secure. Um, another thing is we're secure because we have XYZ. We encrypted everything, so you wanna think about one control is not enough, and sometimes those controls are more like a speed bump versus a wall, um, and the other one is we have this, uh, that was we have this great control, um, so we're good so there may be a bypass, um, you've created this architecture where you have this control but someone can just kind of go around this control and go around whatever that control is to get into your environment. Another thing I always think about with security is complexity is the enemy of security so as we try to get more and more complex and more and more security controls, it's gonna start breaking down because someone's gonna make a mistake, people are gonna try to get around it, you know, so you want it to be simpler, but on the other hand, if it's too simple, it's not really doing what it's supposed to do, right? So if I don't wanna use a key when I leave my house because it's too complicated, well that's not really smart because someone's gonna try the door and just break in, right? So we're always trying to balance these things out and this is where I kind of got stuck when I was writing my blog series I kind of stopped writing for a while because I built something that was so complex I'm like no no it has to be simpler so how do I meet my objectives from a security standpoint but make it simpler so it's kind of this um continuously iterative approach. And the other one is if I had more time I would write a shorter letter Mark Twain. I would write you a shorter presentation. I'm trying to tell you a lot of things in a short amount of time, but one of the things I always say is every line of code is a potential bug. So take a look at your code base. You really need all that code. How can you streamline it, uh, depending on, you know, especially using AI, it'll sort of duplicate code all over the place. You wanna streamline that, not have so many places to fix if there is a bug. And the other one is real time third party code injection. I have a blog post on that, so. Um, there are a lot of cases where third party code has been an injection point for malware, so my question is, do you need to run that third party code, access that third party API, or can you bring that internal and host it yourself and scan it, make sure it's not changing along the way like Polyphil IO if you guys are familiar with that, um, is an API I saw a lot on Pentest and all of a sudden it was taken over by another group and it somehow had supposedly had malware in it. They say it wasn't, but those are the things you wanna be careful with. I talk a lot about abstraction on my blog so I'll let you go read those I have links in here, but essentially, um, you can think about ways you can abstract out the things you're doing into common components and that will help you with security. You'll have less to manage if you have some code to fix and you have abstracted it to a common class, you have one class to fix. So think about, uh, ways you can use abstraction and I use abstraction as a way to build my batch jobs in a repeatable secure manner. So there's a lot of security considerations when we're um looking at batch job security you know I have a list of them here but uh some of the things I thought about is, you know, I wanna have uh one MFA every time so when you run the batch job is MFA is required uh you wanna make sure it's in a private network if you can, um, maybe you have it connecting to certain resources so it's gonna reach out to some things but you wanna really make that network as restrictive as possible. Um, and then, uh, you can use K KMS a lot for encrypting the data and you can use KMS in conjunction with your IM roles, so you can restrict who has access to use which keys and so on. Um, and there's a lot more here, but you can take a look at that. All right, so I've been doing a lot on my blog with um AI and vibe coding by coding AI agents, things like that and it's really fascinating because you can put something in there and say give me a cloud formation template it's really great. So I put something in I said give me a VPC network and the template came back it was pretty cool, right? And then I said I have this cloud formation, uh, or cloud front website running in S3 bucket with all these different um. Configurations and give me all the templates for that well then it kind of broke down because it's a lot more complex, right? So when you're thinking about AI you wanna understand that you know it's gonna do some things really great, but at the end of the day you still need to check it and a lot of that has to do with uh the fact that it's a predictive model. So I like to say when you're using, you know, if you've ever been on social media and you you someone says go put in these words into your um. Phone and whatever three words come up next that's what you are, you know and so it's trying to predict what um what the next words are on your phone and what comes up on your phone is different than what comes up on someone else's phone and maybe even what comes up on your phone is different like to other times so when you're thinking about using AI this is sort of a new threat it's a predictive model you probably don't wanna be using that for bank statements, but there are a lot of use cases where it's appropriate if you do use it, you wanna check it. And then doing a lot of research in this area too. There are the way the models work, they can put together tokens in strange ways that the models understand but are actually not correct from a human perspective like if it can handle French and German, let's say it could bring it together two tokens from different languages and put them together. I actually had this happen with uh YAML and Jason when I was doing cloud formation templates. At some point Amazon Q was giving me this mishmash of YAML and Jason. It was not right, so be aware that can happen. Um, a lot of people are also jumping on the AI bandwagon and they're not doing all the traditional security controls with their agents and like I said, an AI, um, agent is essentially a batch job so all these things I'm talking to you about are still applicable in AI and I, I like the last talk on and. MCP servers as well because out of the box they don't have authentication right so they were talking all about an open source uh tool A address put together um to do that so a lot of things to consider there can quite cover it all but um just as a summary batch jobs can help you process data more securely because you can put your processes into a secure environment and really lock it down and keep them away from the developer machines, for example. And then um you wanna make sure that your inputs and outputs and your processing are all secure like all the way through what you're putting in what you're getting out what you're processing in the middle, all those things need to be secure. AWS provides you all the services to do that, but you have to use them effectively and that's kind of what I was going through on my blog where I was trying out different services to do different things to implement the system. I think about the cost, how could it be attacked and have things on privilege escalation out there and you know a lot of different tasks that can happen on AWS. Um, so yeah, base your batch job security architecture and whatever you're building on a threat model. Look what the threats are, look what's happening to other people, and figure out how you can design something that protects against it. Thank you.
