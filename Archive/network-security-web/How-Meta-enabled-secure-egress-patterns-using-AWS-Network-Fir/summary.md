# AWS re:Inforce 2025 - How Meta enabled secure egress patterns using AWS Network Firewall (NIS321)

**Video Link:** [Watch on YouTube](https://www.youtube.com/watch?v=me0uQLIZEfM)

## Video Information
- **Author:** AWS Events
- **Duration:** 14.2 minutes
- **Word Count:** 2,591 words
- **Publish Date:** 20250618
- **Video ID:** me0uQLIZEfM

## Summary
This presentation focused on how Meta implements secure network patterns using AWS Network Firewall, particularly for their AI and high-performance computing (HPC) workloads. Meta primarily uses AWS for specialized capabilities that augment their data center operations, rather than their main production workloads.
The discussion highlighted the unique challenges Meta faces with AI research workloads, which require more flexible and reactive internet access compared to traditional service workloads. These AI workloads involve researchers performing ad-hoc tasks within HPC clusters, necessitating special security considerations while maintaining accessibility for legitimate research needs.

## Key Points
- Meta deploys individual workloads in separate AWS accounts following AWS best practices, with tight integration to their data centers
- Traditional security groups and NACLs are insufficient for Meta's needs due to the large number of data center IP ranges and DNS-based partner integrations
- AI/HPC workloads present unique challenges due to researchers needing flexible internet access while maintaining strict security requirements
- HPC clusters are typically deployed in single regions based on GPU availability, creating additional challenges for cross-region service access
- Network Firewall provides necessary flexibility and scalability for Meta's complex security requirements

## Technical Details
- AWS Network Firewall Features:
  - Scales to hundreds of gigabits per second
  - Supports hundreds of thousands of connections
  - Layer 3-7 rule engine with AWS managed rules
  - Custom rule creation capabilities
- Implementation Components:
  - VPC endpoints for local service access
  - Bastion hosts for administrative access
  - Ingress subnets with Network Firewall endpoints
  - Multiple security layers: VPC routing, Security Groups, NACLs
  - Cross-region service access considerations
- Traffic Patterns:
  - Egress (outbound) for data exfiltration prevention
  - Ingress (inbound) for external traffic control
  - VPC-to-VPC (east-west) for lateral movement prevention

## Full Transcript

Hello. Do you consider your firewall a critical part of your AI infrastructure? I'm Robin Rodriguez, a solutions architect at AWS. I'm joined here alongside with Casey Braunschweig, a production engineer at Meta, as well as Syed Sharif, a security specialist, SA also at AWS, and we're gonna talk. About how uh Metas used AWS network firewall to secure their AI high performance workloads and with that I'm gonna pass it over to Casey who's going a little overview of how Meta uses AWS. So you are probably familiar with Meta and we serve you billions of people a day across our family of apps. Um, from, but mostly from our production data centers, so we have our own data centers around the world, so you might not be familiar with how we use AWS as you might expect, we don't use AWS for the bulk of that huge workload. We use it for certain specialized capabilities, things that augment what we do in our data centers and so as a result, one of the things we have to do is tightly integrate the individual workloads in AWS with what we do in our data centers um we manage all that. Infrastructure from you know virtual development environment that exists as part of our production infrastructure. nobody's managing the stuff from laptops and we also deploy an AWS with sort of typical AWS best practice individual workloads in individual accounts owned by the service teams that own that that individual service, right? So let's look at a typical workload before we get to the the AI fanciness. So this is probably pretty familiar to you. Um, but, uh, workload deployed in AWS inside of a BPC is typically focused on one particular sort of workload, a set of instances that serves some workload, and we typically deploy that alongside a bastion host that's used for administrative purposes. And so most of the um dependencies for this are gonna be local to that that VPC right? Most of the ingress and egress traffic here is from our production environment from our data centers, right? You've got administrative like SSH coming into that bastion host maybe some like clients and service requests coming into that workload from the outside, um, it might be reaching. Out to our production data centers for some service dependency something like that but that's the bulk of the ingress and egress here, right? Most of the dependencies are region local they're access through VPC end points we may have some vendors or partners we need to integrate with, but that's pretty limited and so the using the Internet is is pretty limited something like this. This is a service workload. Right, um, this is also something you would stamp out, so you would say deploy this in one region and then deploy it in multiple regions for resiliency or to be close to certain clients, things like that. um, so what do you need a firewall here? You've already got security groups, network ales, like what do you need a third layer of firewalling for? There's a couple of use cases that network firewall can be helpful here. One is that because our data centers are so large and numerous, the IP space to describe those data centers is actually quite large. So trying to put together a list of cider blocks to describe it, like you're quickly running up against the limits of what you can do with a security group. You need more rules than that. And if you want to get granular and start limiting that down, you might need hundreds of rules, hundreds of cider blocks, and it's just not possible with security groups. Um, also some vendors and partners may not be able to give us a set of IPs for the end point we need to integrate with. They may only be able to give us a DNS name. And that's just not something we can do as security groups, so we need another firewall. We need something like network firewall. Um, but you guys wanted to hear about AI. So let's talk about an AI workload. Um, we're doing a bunch of stuff with AI and in AWS in particular we're deploying HPC clusters for AI research, um, so very large GPU clusters, and these are not used by, you know, service teams running a production service. These are primarily used by AI researchers doing research. Workloads and what that means is instead of a service that people only log into administratively, you've got researchers logging in day in and day out doing ad hoc things within the HBC cluster which really changes the nature of their requirements for egress access, access to the internet, right? They're doing new things, pushing the boundaries every day looking at benchmarks, looking at other research, working with new partners all the time. This changes very quickly and so we need to be very flexible and reactive to the kind of access to the internet that they need, but at the same time we have not only our normal level of like security requirements, but there's a whole another list of requirements unique and specific to AI data that we also have to meet and so we got these things pulling in opposite directions. It's quite a challenge. Um, the other thing that's different with HPC is that HPC clusters are not deployed in a bunch of regions just based on reliability. Instead they're typically special snowflakes in a single region based on something like GPU availability. And so now you're in one region you can no longer count on being able to deploy all of your dependencies VPC local or region local, right? So now we have this problem of oh we need AWS services in another region as well. Right, so, um, as you, you may have run into right, AWS services like the AWS public service APIs for some other region are the internet also, right? You can't use VPC end points for everything, um, so that's sort of some of our challenges, and then I'm gonna hand it over to Robin who's gonna talk a little bit in general about network firewall before we get to how we actually used it. Thank you, Casey. So what is it that makes AWS network firewall ideally suited for these use cases? And you can think of AWS network firewall really as your cloud native firewall, scaling to hundreds of gigabits per second, supporting hundreds. Of thousands of connections you have a rule engine that allows you to leverage AWS managed and created rules as well as create your own rules from layer 3 to layer 7 to support your individual use cases. And building on that there are a couple different traffic paths that allow you to protect your environments. I'm gonna start off first with egress. We're gonna dive up quite a bit deeper into that here in just a minute, but egress or outbound, this is your ability to um block and prevent data exfiltration or access to unapproved services from your AWS environment. And then secondly we have the ingress or the inbound path and so this is where you can prevent this unapproved or malicious traffic from reaching your services from um external entities. And then finally, the final traffic path we'll talk about here is we call VPC to VPC or sometimes east to west traffic and think of this as how you prevent lateral movement between your AWS environments and secure your service to service communications and I'm gonna kick it over to Sayed who's gonna go a bit deeper into Meta's deployment. Thank you, Robin. So now that you know everything about meta, and you also know everything about network firewall. So let's talk about how meta uses it for that ingress pattern and that egress pattern. So let's start with ingress. Now with ingress, the first thing meta does is they have a network firewall in the ingres subnet. So the traffic coming in islands into an ingress subnet from where the network firewall endpoint is. Then from that, after the inspection, the traffic comes into the intra subnet. From there, it goes into the private workload, um, subnets. As you can see, there is a layered approach that MET has taken to build the security controls that are offered by AWS. The first one is the BPC routing, which allows which ensures that the res is only allowed via the English firewall to the intraubnet before from the internet. Then the network firewall itself that allows me to write those granular ciders for Meta's prod uh IP space, which is massive and security grave alone would not scale to. But in addition to that, there are SSH IPs for researchers and others to be able to get to the bastion host. And then third but last, and last but not least is security groups. And this is where, even though we have the network firewall taking that layered approach, we also have core cider blocks that map back to the source IPs on Metas broad network. So as you can see, similarly, you also have the egress deployment. In the egress now we have our, uh, private workloads from our private subnets that are now and again remember the login pods and the HPC clusters that uh KC talked to us about. From there they're going to an egress subnet where again the network firewall endpoint is deployed into and from there into N gateway out to the internet. Now here based on those different paths that um case you uh recommend shown, you'll see we take the opposite approach we build the funnel the other way around now. So we start with the security groups here it's much coarse because we either limit to none or the meta only or the internet because that's what the use case is. Then in addition to that, we have the VPC routing which is restricting all egress traffic to only to that egress subnet from where the network firewall inspection would occur. And then within the network firewall, you have granular ciders blocks for metarod. In addition to that, the domain allow listing that Casey alluded to earlier about talking to vendors and researchers and others uh that they can vendors and partners that, uh, researchers can use. So all that is implemented in the network firewall and then. The traffic is able to safely aggress out onto the internet. Um, to talk about further about some of the key outcomes, I'll let Casey come in and close it. OK. Thank you very much, Syed. You're welcome. So What did we get from all this? So now that you know how this works, um, you can see that we get this level of filtering of cider blocks where we keep the existing security groups network echos that we already have and then layer on something that's a lot more capable of handling the level of rules definition that we need to get granular. So you know if we need hundreds or thousands of cider blocks to describe a particular. Use case we can do that and it's not a problem um also now we get this layer 7 filtering ability we can filter on domain names we can filter, um, you know, things above the IP level and so not only does this allow us to work with vendors and partners and whoever but also. Do very granular allow listing for researchers that can also update very rapidly and it's very understandable for them to make it easy for them to access something new um that that we didn't allow yesterday but also keep track of it and keep it very locked down. Um, let's see, this is not the end. There are things that we can go forward and look at further. So one of them I mentioned was things like S3, places where VPC end points are not enough because we have these cross region, uh, dependencies because we can't deploy everything in the local region where the HPC cluster is. If we're willing to accept the limitation of accessing S3 buckets by their DNS names, um, like individual bucket DNS names, then we can also do that like layer 7 allow listing at the level of individual S3 buckets, um, which is a pretty cool thing to be able to add. Um, we've been talking a little bit about some of this layer 7 filtering and some of this, these capabilities that Network firewall has this is all without enabling TLS inspection. Um, which people may not know you can do, but we can also enable TLS inspection and you get some additional capabilities that we don't have today. That's something that we're gonna look into. Um, an interesting one is VPC block public access. This is a pretty new feature that came out last year. Um, if you're not familiar with it, basically you can completely block access as in a declarative way from the VPC to the Internet gateway, and then you create specific like subnet level exclusions of where you should be able to get to the Internet gateway. So I had mentioned, um, our routing rules are an important part of forcing every all of the traffic through these ingress and egress. By having those separate ingress and egress firewall subnets, right now we're dependent on those routing rules. If there were to be a mistake, if there were to be some malicious change to a routing table, perhaps you could create a way around the firewall. Well with BBC block public access, we can have another layer of security that says even if you manage to avoid that firewall, you're not going to get to the internet gateway. Um, that is something that we're waiting on, so there is a compatibility issue with network firewall and the specific ingress flow that we use. Um, so I'm hoping that soon AWS will announce a solution to that, and then we'll be able to enable this across these workloads, um, and then finally, uh, Route 53 DNS firewall is something that you can layer on on top of this and so in some cases we. Block certain traffic patterns at the DNS level before they hit network firewall. They would be blocked by network firewall, but we save the traffic, save the cost, save those things and stop that at the DNS level. So we've got, you know, more places we can go from here, but I think for a lightning talk we'll probably call it there, and I will say thank you very much. I appreciate you and hand it back to these guys to wrap it up. Thank you, Casey. So thank you so much. Again, as a lightning talk, we could only go into so much depth. I'm sure you have plenty of questions. Uh, please bring this to us. We'll be standing right here. But in addition, please give us this feedback in the survey on your app. That helps us improve and hopefully turn this into a much deeper, uh, more, uh, technical in-depth conversation for a future, uh, conference. But thank you again so much for your time. I hope you found this useful and helpful and looking forward to all of you using all the different layered controls we mentioned today. Thank you.
